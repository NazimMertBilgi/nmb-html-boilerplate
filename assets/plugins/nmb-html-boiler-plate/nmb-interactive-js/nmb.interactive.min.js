class NMBInteractiveJSHandler{constructor(e){this.scriptElement=document.getElementById(e),this.init(e)}async init(e){let t=document.querySelector("script#"+e).src;if(t&&null!==t&&""!==t){let i=await this.fetchScriptContent();this.scriptElement.textContent=i}if(this.variables={},this.variablesLastContents=[],!this.scriptElement){console.error(`Script with id '${e}' not found.`);return}this.initVariables(),this.createProxies(),this.updateDOM(),this.nmbInteractiveLoadedEvent()}async fetchScriptContent(){return await fetch(this.scriptElement.src).then(e=>e.text())}initVariables(){try{let e=this.scriptElement.textContent.match(/(const|let|var)\s+(\w+)\s*=\s*(['"].*?['"]|\d+|\(.*?\))/g);e&&e.forEach(e=>{let t=e.match(/(const|let|var) (\w+)\s*=\s*['"()](.*?)['")]/);t&&(this.variables[t[2]]=t[3],this.variablesLastContents.push({key:t[2],value:t[3]}))}),this.variables=Object.entries(this.variables)}catch(t){console.error("Failed to parse JSON from script element:",t)}}createProxies(){this.variables.forEach(([e,t])=>{window[e]=new Proxy({value:t},{set:(t,i,r,a)=>(t[i]=r,this.handleVariableChange(e,r),this.updateVariableInDOM(e,r),!1)})})}handleVariableChange(e,t){let i=this.variablesLastContents.find(t=>t.key===e);if(t===i.value)return!1;let r=new CustomEvent("nmbInteractiveVariableChanged",{detail:{variable:e,newValue:t,oldValue:i.value}});document.dispatchEvent(r)}updateVariableInDOM(key,value){let elementsToUpdate=document.querySelectorAll("body *");elementsToUpdate.forEach(element=>{let attrId="nmb-interactive-id",attr2Id="nmb-interactive-extra-feature",variableLastContent=this.variablesLastContents.find(e=>e.key===key);if(variableLastContent){let elementsWithAttrId=document.querySelectorAll(`[${attrId}="${variableLastContent.key}"]`);elementsWithAttrId.forEach(el=>{let extraFeature=el.getAttribute(attr2Id);if(el.hasAttribute(attr2Id)){if("num"===extraFeature){let expression=variableLastContent.value,result=eval(expression);el.innerHTML=el.innerHTML.replace(result,value)}else if("bool"===extraFeature){let expression=variableLastContent.value,result=!!eval(expression);el.innerHTML=el.innerHTML.replace(result,value)}else if("attr"===extraFeature){let attributes=el.attributes;for(let i=0;i<attributes.length;i++)attributes[i].value===variableLastContent.value&&el.setAttribute(attributes[i].name,value);el.outerHTML=el.outerHTML}else el.innerHTML=el.innerHTML.replace(variableLastContent.value,value)}else el.innerHTML=el.innerHTML.replace(variableLastContent.value,value)}),variableLastContent.value=value}})}updateDOM(){let regex=/\{{(.*?)\}}/g,elements=document.querySelectorAll("body *");elements.forEach(element=>{if(0===element.children.length){let outerHTML=element.outerHTML,match;for(;null!==(match=regex.exec(outerHTML));){let variableName=match[1].trim();if(variableName.startsWith("num(")&&variableName.endsWith(")")){let doubleVariableName=variableName.slice(4,-1).trim(),expression=variableName.slice(4,-1);try{let result=eval(expression),attrId="nmb-interactive-id",attr2Id="nmb-interactive-extra-feature",variable=this.variables.find(([e])=>e===doubleVariableName);variable&&(element.setAttribute(attrId,variable[0]),element.setAttribute(attr2Id,"num")),outerHTML=element.innerHTML.replace(match[0],result),element.innerHTML=outerHTML}catch(e){console.error("Failed to evaluate expression:",e)}}else if(variableName.startsWith("bool(")&&variableName.endsWith(")")){let doubleVariableName=variableName.slice(5,-1).trim(),expression=variableName.slice(5,-1);try{let result=!!eval(expression),attrId="nmb-interactive-id",attr2Id="nmb-interactive-extra-feature",variable=this.variables.find(([e])=>e===doubleVariableName);variable&&(element.setAttribute(attrId,variable[0]),element.setAttribute(attr2Id,"bool")),outerHTML=element.innerHTML.replace(match[0],result),element.innerHTML=outerHTML}catch(e){console.error("Failed to evaluate expression:",e)}}else if(variableName.startsWith("attr(")&&variableName.endsWith(")")){let attrVariableName=variableName.slice(5,-1).trim(),attrId="nmb-interactive-id",attr2Id="nmb-interactive-extra-feature",variable=this.variables.find(([e])=>e===attrVariableName);variable&&(element.setAttribute(attrId,variable[0]),element.setAttribute(attr2Id,"attr"));let attributes=element.attributes;for(let i=0;i<attributes.length;i++)attributes[i].value===match[0]&&element.setAttribute(attributes[i].name,variable[1])}else{let variable=this.variables.find(([e])=>e===variableName);if(variable){let attrId="nmb-interactive-id";element.setAttribute(attrId,variable[0]),outerHTML=element.innerHTML.replace(match[0],variable[1]),element.innerHTML=outerHTML}}}}})}nmbInteractiveLoadedEvent(){let e=new CustomEvent("nmbInteractiveLoaded",{detail:{isLoaded:!0}});document.dispatchEvent(e)}}new NMBInteractiveJSHandler("nmb-html-boiler-plate-js");